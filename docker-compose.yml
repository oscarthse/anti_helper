version: "3.9"

services:
  # ============================================
  # THE BODY - FastAPI Orchestrator
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock  # For sandbox control
    environment:
      - DATABASE_URL=postgresql+asyncpg://gravity:gravity@postgres:5432/antigravity
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gravity-net

  # ============================================
  # Dramatiq Workers (Agent Runners)
  # ============================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: dramatiq backend.app.workers --processes 2 --threads 4
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DATABASE_URL=postgresql+asyncpg://gravity:gravity@postgres:5432/antigravity
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - gravity-net

  # ============================================
  # PostgreSQL - Single Source of Truth
  # ============================================
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: gravity
      POSTGRES_PASSWORD: gravity
      POSTGRES_DB: antigravity
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gravity -d antigravity"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gravity-net

  # ============================================
  # Redis - Message Broker for Dramatiq
  # ============================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gravity-net

  # ============================================
  # Sandbox - Isolated Execution Environment
  # ============================================
  sandbox:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    # This container is spawned on-demand by the agent
    # It has NO network access and limited resources
    network_mode: "none"
    mem_limit: 512m
    cpus: 1.0
    read_only: true
    tmpfs:
      - /tmp:size=100M
    security_opt:
      - no-new-privileges:true
    profiles:
      - sandbox  # Only started when explicitly requested

volumes:
  postgres-data:
  redis-data:

networks:
  gravity-net:
    driver: bridge
